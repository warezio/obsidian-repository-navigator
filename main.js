var D=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var V=(n,a)=>{for(var e in a)D(n,e,{get:a[e],enumerable:!0})},I=(n,a,e,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let i of L(a))!R.call(n,i)&&i!==e&&D(n,i,{get:()=>a[i],enumerable:!(t=F(a,i))||t.enumerable});return n};var O=n=>I(D({},"__esModule",{value:!0}),n);var H={};V(H,{default:()=>E});module.exports=O(H);var A=require("obsidian");var u="repo-nav-tree-view",v="repo-nav-hidden-file",T={showHiddenDirs:!0,fileExtensions:".md",excludedDirs:"node_modules,.git",sortOrder:"folders-first",collapseOnStartup:!1},w="folder-tree";var g=require("obsidian"),y=class extends g.PluginSettingTab{constructor(a,e){super(a,e),this.plugin=e}display(){let{containerEl:a}=this;a.empty(),new g.Setting(a).setName("Show hidden directories").setDesc("Include dot-prefixed directories (e.g., .github, .obsidian) in the tree. Hidden folders are shown by default.").addToggle(e=>e.setValue(this.plugin.settings.showHiddenDirs).onChange(async t=>{this.plugin.settings.showHiddenDirs=t,await this.plugin.saveSettings()})),new g.Setting(a).setName("File extensions").setDesc("Comma-separated list of extensions to include (e.g., .md,.mdx).").addText(e=>e.setPlaceholder(".md").setValue(this.plugin.settings.fileExtensions).onChange(async t=>{this.plugin.settings.fileExtensions=t,await this.plugin.saveSettings()})),new g.Setting(a).setName("Excluded directories").setDesc("Comma-separated directory names to always exclude.").addText(e=>e.setPlaceholder("node_modules,.git").setValue(this.plugin.settings.excludedDirs).onChange(async t=>{this.plugin.settings.excludedDirs=t,await this.plugin.saveSettings()})),new g.Setting(a).setName("Sort order").setDesc("How to sort files and directories in the tree.").addDropdown(e=>e.addOption("folders-first","Folders first").addOption("az","Alphabetical (A-Z)").addOption("za","Alphabetical (Z-A)").setValue(this.plugin.settings.sortOrder).onChange(async t=>{this.plugin.settings.sortOrder=t,await this.plugin.saveSettings()})),new g.Setting(a).setName("Collapse on startup").setDesc("Start with all directories collapsed when opening the view.").addToggle(e=>e.setValue(this.plugin.settings.collapseOnStartup).onChange(async t=>{this.plugin.settings.collapseOnStartup=t,await this.plugin.saveSettings()}))}};var d=require("obsidian");function _(n){return n.trim()?n.split(",").map(a=>a.trim()).filter(a=>a.length>0).map(a=>a.startsWith(".")?a:"."+a):[]}function W(n){return n.trim()?new Set(n.split(",").map(a=>a.trim()).filter(a=>a.length>0)):new Set}function k(n,a){if(n.type!=="file"){for(let e of n.children)k(e,a);switch(a){case"folders-first":n.children.sort((e,t)=>e.type!==t.type?e.type==="directory"?-1:1:e.name.localeCompare(t.name));break;case"az":n.children.sort((e,t)=>e.name.localeCompare(t.name));break;case"za":n.children.sort((e,t)=>t.name.localeCompare(e.name));break}}}async function C(n,a,e,t,i){let s=[];try{let o=await n.list(a);for(let c of o.files)e.some(r=>c.endsWith(r))&&s.push(c);for(let c of o.folders){let r=c.split("/").pop()||"";if(t.has(r)||!i&&r.startsWith("."))continue;let l=await C(n,c,e,t,i);s.push(...l)}}catch(o){}return s}async function b(n,a){let e=_(a.fileExtensions),t=W(a.excludedDirs),i={name:"/",path:"",type:"directory",children:[]};if(e.length===0)return i;let s=new Map;s.set("",i);let o;a.showHiddenDirs?o=await C(n.vault.adapter,"",e,t,!0):o=n.vault.getFiles().filter(r=>e.some(l=>r.path.endsWith(l))).map(r=>r.path);for(let c of o){let r=c.split("/"),l=r.pop(),p="",h=!1;for(let f of r){let x=p;if(p=p?p+"/"+f:f,t.has(f)){h=!0;break}if(!a.showHiddenDirs&&f.startsWith(".")){h=!0;break}if(!s.has(p)){let N={name:f,path:p,type:"directory",children:[]};s.set(p,N),s.get(x).children.push(N)}}if(!h){let x={name:l.replace(/\.[^.]+$/,""),path:c,type:"file",children:[]};s.get(p).children.push(x)}}return k(i,a.sortOrder),i}var S=class{constructor(a){this.document=a;this.menuEl=null;this.closeCallback=null;this.setupGlobalClickListener()}show(a,e,t){this.hide();let i=this.document.createElement("div");i.addClass("repo-nav-context-menu");for(let p of t){let h=i.createDiv({cls:"repo-nav-context-menu-item"});h.createSpan({cls:"repo-nav-context-menu-icon"}),(0,d.setIcon)(h,p.icon),h.createSpan({text:p.label}),h.addEventListener("click",f=>{f.stopPropagation(),p.action(),this.hide()})}this.document.body.appendChild(i);let s=150,c=t.length*36+8,r=a,l=e;r+s>this.document.body.clientWidth&&(r=this.document.body.clientWidth-s-8),l+c>this.document.body.clientHeight&&(l=this.document.body.clientHeight-c-8),i.style.left=`${r}px`,i.style.top=`${l}px`,this.menuEl=i}hide(){this.menuEl&&(this.menuEl.remove(),this.menuEl=null)}setupGlobalClickListener(){this.document.addEventListener("click",()=>{this.hide()})}},m=class extends d.ItemView{constructor(e,t){super(e);this.treeData=null;this.expandedPaths=new Set;this.debounceTimer=null;this.plugin=t,this.contextMenu=new S(this.containerEl.ownerDocument)}getViewType(){return u}getDisplayText(){return"Repository Navigator"}getIcon(){return w}async onOpen(){if(this.expandedPaths=new Set,this.treeData=await b(this.app,this.plugin.settings),!this.plugin.settings.collapseOnStartup&&this.treeData)for(let e of this.treeData.children)e.type==="directory"&&this.expandedPaths.add(e.path);this.renderView(),this.registerEvent(this.app.vault.on("create",()=>this.debouncedRefresh())),this.registerEvent(this.app.vault.on("delete",()=>this.debouncedRefresh())),this.registerEvent(this.app.vault.on("rename",()=>this.debouncedRefresh())),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>this.updateActiveFile()))}async onClose(){this.debounceTimer!==null&&clearTimeout(this.debounceTimer)}expandAll(e){let t=this.findNode(this.treeData,e);if(t){let i=this.collectDescendantPaths(t);for(let s of i)this.expandedPaths.add(s);this.renderView()}}collapseAll(e){let t=this.findNode(this.treeData,e);if(t){let i=this.collectDescendantPaths(t);for(let s of i)this.expandedPaths.delete(s);this.renderView()}}findNode(e,t){if(!e)return null;if(e.path===t)return e;for(let i of e.children){let s=this.findNode(i,t);if(s)return s}return null}collectDescendantPaths(e){let t=[];if(e.type==="directory"){t.push(e.path);for(let i of e.children)t.push(...this.collectDescendantPaths(i))}return t}renderView(){this.contentEl.empty();let e=this.contentEl.createDiv({cls:"repo-nav-header"}),t=this.collectAllDirPaths(this.treeData),i=t.size>0&&t.size===this.expandedPaths.size,s=e.createEl("button",{attr:{"aria-label":i?"Collapse all":"Expand all"}});(0,d.setIcon)(s,i?"chevrons-down-up":"chevrons-up-down"),s.addEventListener("click",()=>{if(i)this.expandedPaths.clear();else for(let r of t)this.expandedPaths.add(r);this.renderView()});let o=e.createEl("button",{attr:{"aria-label":"Refresh"}});(0,d.setIcon)(o,"refresh-cw"),o.addEventListener("click",()=>{this.refreshTree()});let c=this.contentEl.createDiv({cls:"repo-nav-tree"});if(!this.treeData||this.treeData.children.length===0){c.createDiv({cls:"repo-nav-empty",text:"No Markdown files found in this vault."});return}for(let r of this.treeData.children)this.renderNode(c,r,0)}renderNode(e,t,i){let s=e.createDiv({cls:"repo-nav-node"});if(s.style.paddingLeft=`${i*16}px`,s.dataset.path=t.path,t.type==="directory"){s.addClass("repo-nav-dir");let o=this.expandedPaths.has(t.path),c=s.createSpan({cls:"repo-nav-chevron"});(0,d.setIcon)(c,o?"chevron-down":"chevron-right");let r=s.createSpan({cls:"repo-nav-icon"});if((0,d.setIcon)(r,"folder"),s.createSpan({cls:"repo-nav-name",text:t.name}),s.addEventListener("click",l=>{l.stopPropagation(),this.expandedPaths.has(t.path)?this.expandedPaths.delete(t.path):this.expandedPaths.add(t.path),this.renderView()}),s.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation(),this.contextMenu.show(l.clientX,l.clientY,[{label:"Expand All",icon:"chevrons-up-down",action:()=>this.expandAll(t.path)},{label:"Collapse All",icon:"chevrons-down-up",action:()=>this.collapseAll(t.path)}])}),o){let l=e.createDiv({cls:"repo-nav-children"});for(let p of t.children)this.renderNode(l,p,i+1)}}else{s.addClass("repo-nav-file");let o=this.app.workspace.getActiveFile();o&&o.path===t.path&&s.addClass("repo-nav-active");let c=s.createSpan({cls:"repo-nav-icon"});(0,d.setIcon)(c,"file-text"),s.createSpan({cls:"repo-nav-name",text:t.name}),s.addEventListener("click",async r=>{r.stopPropagation();let l=r.metaKey||r.ctrlKey,p=this.app.vault.getAbstractFileByPath(t.path);p instanceof d.TFile?l?await this.app.workspace.getLeaf("tab").openFile(p):await this.app.workspace.getLeaf(!1).openFile(p):await this.openHiddenFile(t.path,l)})}}collectAllDirPaths(e){let t=new Set;if(!e)return t;let i=s=>{s.type==="directory"&&s.path&&t.add(s.path);for(let o of s.children)i(o)};return i(e),t}debouncedRefresh(){this.debounceTimer!==null&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.refreshTree()},300)}updateActiveFile(){let e=this.app.workspace.getActiveFile();if(this.containerEl.querySelectorAll(".repo-nav-file").forEach(i=>i.removeClass("repo-nav-active")),e){let i=this.containerEl.querySelector(`.repo-nav-file[data-path="${CSS.escape(e.path)}"]`);i&&i.addClass("repo-nav-active")}}async refreshTree(){this.treeData=await b(this.app,this.plugin.settings),this.renderView()}async ensureVaultFile(e){let t=this.app.vault.getAbstractFileByPath(e);if(t instanceof d.TFile)return t;try{let i=this.app.vault.adapter,s=e.split("/");s.pop();let o="";for(let l of s)if(o=o?o+"/"+l:l,!this.app.vault.getAbstractFileByPath(o)){let p=i.getRealPath(o);await i.reconcileFolderCreation(p,o)}let c=i.getRealPath(e);if(typeof i.reconcileFileInternal=="function")await i.reconcileFileInternal(c,e);else if(typeof i.reconcileFileChanged=="function"){let l=i.getFullRealPath(c),p=await i.fs.stat(l);p&&i.reconcileFileChanged(c,e,p)}let r=this.app.vault.getAbstractFileByPath(e);return r instanceof d.TFile?r:null}catch(i){return null}}async openHiddenFile(e,t){let i=this.app.workspace.getLeaf(t?"tab":!1),s=await this.ensureVaultFile(e);if(s){await i.openFile(s);return}await i.setViewState({type:v,state:{filePath:e}}),this.app.workspace.revealLeaf(i)}},P=class extends d.ItemView{constructor(){super(...arguments);this.filePath=""}getViewType(){return v}getDisplayText(){return this.filePath?(this.filePath.split("/").pop()||this.filePath).replace(/\.[^.]+$/,""):"Hidden File"}getIcon(){return"file-text"}async setState(e,t){e.filePath&&(this.filePath=e.filePath,await this.renderContent()),await super.setState(e,t)}getState(){return{filePath:this.filePath}}async onOpen(){this.addAction("external-link","Open in default app",()=>{this.app.openWithDefaultApp(this.filePath)}),this.filePath&&await this.renderContent()}async renderContent(){this.contentEl.empty(),this.contentEl.addClass("markdown-reading-view"),this.contentEl.createDiv({cls:"repo-nav-hidden-file-path"}).createSpan({text:this.filePath});let i=this.contentEl.createDiv({cls:"repo-nav-hidden-file-content markdown-preview-view markdown-rendered"}).createDiv({cls:"markdown-preview-sizer markdown-preview-section"});try{let s=await this.app.vault.adapter.read(this.filePath);await d.MarkdownRenderer.render(this.app,s,i,this.filePath,this)}catch(s){i.createDiv({cls:"repo-nav-empty",text:"Unable to read file."})}}};var E=class extends A.Plugin{constructor(){super(...arguments);this.settings=T}async onload(){await this.loadSettings(),this.registerView(u,e=>new m(e,this)),this.registerView(v,e=>new P(e)),this.addRibbonIcon(w,"Repository Navigator",()=>{this.activateView()}),this.addCommand({id:"open-repo-nav",name:"Open tree view",callback:()=>{this.activateView()}}),this.addSettingTab(new y(this.app,this)),this.app.workspace.onLayoutReady(()=>{this.activateView()})}onunload(){this.app.workspace.detachLeavesOfType(u)}async activateView(){let e=this.app.workspace.getLeavesOfType(u);if(e.length>0){this.app.workspace.revealLeaf(e[0]);return}let t=this.app.workspace.getLeftLeaf(!1);t&&(await t.setViewState({type:u,active:!0}),this.app.workspace.revealLeaf(t))}async loadSettings(){let e=await this.loadData();this.settings=Object.assign({},T,e)}async saveSettings(){await this.saveData(this.settings);let e=this.app.workspace.getLeavesOfType(u);for(let t of e){let i=t.view;i instanceof m&&await i.refreshTree()}}};
